<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptoStream - Login</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        html, body { height: 100%; }
        body {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #111827;
        }
        .tab-active {
            border-bottom: 2px solid #3b82f6;
            color: white;
        }
    </style>
</head>
<body>

<!-- Logo centrado arriba del formulario -->
<div class="absolute top-8 left-1/2 transform -translate-x-1/2 flex items-center">
    <span style="display:inline-block; width:52px; height:52px; border-radius:50%; background: linear-gradient(135deg, #323470 75%, #3f2a71 50%); box-shadow: 0 2px 8px rgba(13, 10, 54, 0.3); position:relative;">
        <svg width="52" height="52" viewBox="0 0 52 52" style="position:absolute; top:0; left:0;">
            <polygon points="21,16 40,26 21,36" fill="#341c6c" opacity="0.9"/>
        </svg>
    </span>
    <span class="text-3xl font-bold text-white ml-4" style="letter-spacing:-0.5px;">CryptoStream</span>
</div>

<div class="w-full max-w-sm p-8 bg-gray-800 rounded-lg shadow-lg">

    <!-- Tabs -->
    <div class="flex justify-around mb-6">
        <button id="btn-login" class="tab-active text-indigo-300 font-bold pb-2">Iniciar Sesión</button>
        <button id="btn-register" class="text-indigo-400 font-bold pb-2">Registrarse</button>
    </div>

    <!-- FORMULARIO -->
    <form id="auth-form" class="space-y-6">

        <div>
            <label class="block text-sm text-gray-300 mb-1">Usuario</label>
            <input id="username" type="text"
                class="w-full px-3 py-2 bg-gray-700 text-white rounded border border-gray-600">
        </div>

        <div>
            <label class="block text-sm text-gray-300 mb-1">Contraseña</label>
            <input id="password" type="password"
                class="w-full px-3 py-2 bg-gray-700 text-white rounded border border-gray-600">
            <p id="pw-help" class="text-xs text-gray-400 mt-1">La contraseña debe tener al menos 8 caracteres, incluir una letra mayúscula y un número.</p>
        </div>

        <button id="submit-btn" type="submit"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg">
            Entrar
        </button>

        <p id="status-msg" class="text-center text-sm mt-3"></p>
    </form>

</div>

<script>
    // Comprobar si hay mensaje de registro persistente
    const savedRegMsg = localStorage.getItem('registrationMessage');
    let mode = savedRegMsg ? 'register' : 'login';
    let isSuccessfulRegistration = !!savedRegMsg;

    const btnLogin = document.getElementById("btn-login");
    const btnRegister = document.getElementById("btn-register");
    const form = document.getElementById("auth-form");
    const statusMsg = document.getElementById("status-msg");
    const submitBtn = document.getElementById("submit-btn");
    const pwHelp = document.getElementById('pw-help');

    function updateTabsUI() {
        if (mode === "login") {
            btnLogin.classList.add("tab-active");
            btnRegister.classList.remove("tab-active");
            submitBtn.textContent = "Entrar";
            if (pwHelp) pwHelp.style.display = 'none';
        } else {
            btnRegister.classList.add("tab-active");
            btnLogin.classList.remove("tab-active");
            submitBtn.textContent = "Registrarse";
            if (pwHelp) pwHelp.style.display = 'block';
        }
    }

    // Inicializar UI
    updateTabsUI();

    // Si hay mensaje de registro guardado, mostrarlo (persistente)
    if (savedRegMsg) {
        statusMsg.textContent = savedRegMsg;
        statusMsg.className = 'text-green-400 text-center text-sm mt-3';
    }

    // --------- CAMBIO DE TABS ---------
    btnLogin.addEventListener("click", () => {
        console.log("Click en LOGIN - limpiando mensaje");
        mode = "login";
        updateTabsUI();
        // Limpiar mensajes cuando cambies a "Iniciar Sesión"
        statusMsg.textContent = "";
        statusMsg.className = "";
        // También eliminar cualquier mensaje persistente de registro
        localStorage.removeItem('registrationMessage');
    });

    btnRegister.addEventListener("click", () => {
        console.log("Click en REGISTER");
        mode = "register";
        updateTabsUI();
    });

    // --------- MANEJAR EL FORMULARIO ---------
    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value.trim();

        // Deshabilitar botón y mostrar indicador mientras se procesa
        const originalBtnText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = mode === 'register' ? 'Registrando...' : 'Autenticando...';

        if (!username || !password) {
            statusMsg.textContent = "Todos los campos son obligatorios.";
            statusMsg.className = "text-red-400 text-center text-sm mt-3";
            // Reactivar botón
            submitBtn.disabled = false;
            submitBtn.textContent = originalBtnText;
            return;
        }

        // --- MODO REGISTRO ---
        if (mode === "register") {
            console.log("Iniciando proceso de REGISTRO");
            // Validación del lado del cliente: 8+ caracteres, al menos una mayúscula y un número
            const pw = password;
            if (pw.length < 8) {
                statusMsg.textContent = 'La contraseña debe tener al menos 8 caracteres.';
                statusMsg.className = 'text-red-400 text-center text-sm mt-3';
                submitBtn.disabled = false;
                submitBtn.textContent = originalBtnText;
                return;
            }
            const pattern = /(?=.*[A-Z])(?=.*\d)/;
            if (!pattern.test(pw)) {
                statusMsg.textContent = 'La contraseña debe incluir al menos una letra mayúscula y un número.';
                statusMsg.className = 'text-red-400 text-center text-sm mt-3';
                submitBtn.disabled = false;
                submitBtn.textContent = originalBtnText;
                return;
            }
            try {
                const res = await fetch("http://localhost:3000/register", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ username, password })
                });

                const data = await res.json();

                if (res.ok) {
                    console.log("REGISTRO EXITOSO - mostrando mensaje verde");
                    // Marcar como registro exitoso
                    isSuccessfulRegistration = true;
                    // Mensaje a mostrar y a persistir
                    const msg = "✓ Registro exitoso. Ahora inicia sesión.";
                    // Mostrar mensaje verde
                    statusMsg.textContent = msg;
                    statusMsg.className = "text-green-400 text-center text-sm mt-3";
                    // Persistir el mensaje para que sobreviva recargas accidentales
                    localStorage.setItem('registrationMessage', msg);
                    // Limpiar campos del formulario
                    document.getElementById("username").value = "";
                    document.getElementById("password").value = "";
                    // Reactivar botón
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalBtnText;
                } else {
                    console.log("Error en registro:", data.error);
                    isSuccessfulRegistration = false;
                    // Eliminar mensaje persistente por si hay uno previo
                    localStorage.removeItem('registrationMessage');
                    statusMsg.textContent = data.error || "Error en el registro.";
                    statusMsg.className = "text-red-400 text-center text-sm mt-3";
                    // Reactivar botón
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalBtnText;
                }
            } catch (err) {
                console.log("Error de conexión:", err);
                isSuccessfulRegistration = false;
                // Asegurarnos de no dejar mensaje persistente en caso de fallo
                localStorage.removeItem('registrationMessage');
                statusMsg.textContent = "Error de conexión al registrar.";
                statusMsg.className = "text-red-400 text-center text-sm mt-3";
                // Reactivar botón
                submitBtn.disabled = false;
                submitBtn.textContent = originalBtnText;
            }

            return;
        }

        // --- MODO LOGIN ---
        if (mode === "login") {
            try {
                const res = await fetch("http://localhost:3000/login", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ username, password })
                });

                const data = await res.json();

                if (res.ok) {
                    // GUARDAMOS EL JWT (mismo nombre que usa index.html)
                    // Guardar JWT y username para que index pueda mostrar el nombre
                    localStorage.setItem("jwt", data.token);
                    localStorage.setItem("username", username);

                    // Limpiar campos y mensajes locales antes de redirigir
                    document.getElementById("username").value = "";
                    document.getElementById("password").value = "";
                    statusMsg.textContent = "";
                    statusMsg.className = "";
                    // Eliminar mensaje persistente de registro (ya no es necesario)
                    localStorage.removeItem('registrationMessage');

                    // Reactivar botón antes de redirigir (opcional)
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalBtnText;
                    // REDIRIGIMOS AL INDEX (usar replace para no dejar login en el historial)
                    // Asegurarnos de que la pestaña activa sea 'watch' después del login
                    try { sessionStorage.setItem('activeSection', 'watch'); } catch (e) {}
                    window.location.replace("index.html");
                } else {
                    statusMsg.textContent = data.error || "Credenciales incorrectas.";
                    statusMsg.className = "text-red-400 text-center text-sm mt-3";
                    // Reactivar botón
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalBtnText;
                }
            } catch (err) {
                statusMsg.textContent = "Error de conexión al iniciar sesión.";
                statusMsg.className = "text-red-400 text-center text-sm mt-3";
                // Reactivar botón
                submitBtn.disabled = false;
                submitBtn.textContent = originalBtnText;
            }
        }
    });
</script>

</body>
</html>
